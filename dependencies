#!/usr/bin/env bash

# if different on linux just put it in darwin block
declare -A dependencies=(
	[bash]='bash|version 5\.'
	[direnv]='direnv|^2\.'
	[gnu-sed]='gsed|GNU sed.*4\.'
	[dialog]='dialog|Version: 1\.'
	[coreutils]='truncate|coreutils.*9\.'
	[git]='git|git version 2\.'
)

if [[ 'Darwin' == $(uname -s) ]]; then
  if [[ ! -x /usr/local/bin/brew ]]; then
    echo "No fun without brew! Install it then try again."
    exit 1
  fi

  echo "Check and brew install missing proenv deps:"
  echo
  missing=()
  for pkg in "${!dependencies[@]}"; do
    pkg_exec="/usr/local/bin/$(echo ${dependencies[$pkg]} | cut -d'|' -f1)"
    pkg_patt="$(echo ${dependencies[$pkg]} | cut -d'|' -f2)"
    prefix="\tbrew ${pkg}                  "
    if $pkg_exec --version | grep -qE "$pkg_patt"; then
      echo -e "${prefix:: 18}\t\tPRESENT: installed"
    else
      echo -e "${prefix:: 18}\t\tMISSING: installing"
      missing+=("$pkg")
    fi
  done
  # install all at once
  brew install ${missing[@]}
fi

